version: 0.2

phases:
  install:
    commands:
      # 1. kubectl ì„¤ì¹˜
      - echo Installing kubectl...
      - curl -O https://s3.us-west-2.amazonaws.com/amazon-eks/1.27.1/2023-04-19/bin/linux/amd64/kubectl
      - chmod +x ./kubectl
      - mkdir -p $HOME/bin && cp ./kubectl $HOME/bin/kubectl && export PATH=$PATH:$HOME/bin
      - aws --version

      # 2. [ì˜¤í•˜ì´ì˜¤] ECR ë¡œê·¸ì¸ (ì´ë¯¸ì§€ í™•ì¸ìš©)
      - echo Logging in to ECR...
      - aws ecr get-login-password --region us-east-2 | docker login --username AWS --password-stdin 416225317325.dkr.ecr.us-east-2.amazonaws.com

      # 3. [ì˜¤í•˜ì´ì˜¤] EKS ì—°ê²°
      - echo Connecting to EKS...
      # ğŸ‘‡ <í´ëŸ¬ìŠ¤í„°_ì´ë¦„>ì„ íŒ€ì›ì—ê²Œ ë¬¼ì–´ë´ì„œ ì •í™•íˆ ë„£ìœ¼ì„¸ìš”! (ì˜ˆ: aivle-cluster-team5)
      - aws eks update-kubeconfig --region us-east-2 --name aivle_bookservice_team5

  build:
    commands:
      # 4. ë°°í¬ ëª…ë ¹ (k8s í´ë” ë‚´ìš© ì ìš©)
      - echo Applying Kubernetes manifests...
      - kubectl apply -f k8s/

      # 5. ì¬ì‹œì‘ (ë°©ê¸ˆ k8s íŒŒì¼ì—ì„œ ì •í•œ ì´ë¦„ 'backend'ë¡œ ì¬ì‹œì‘)
      - kubectl rollout restart deployment/backend

artifacts:
  files:
    - k8s/**/*